/**
 * A responsive image grid for Knockout.js
 * This is largely based off of the work done here: http://www.techbits.de/2011/10/25/building-a-google-plus-inspired-image-gallery/
 * modified for use with Knockout.js
 * uses jQuery for window Resize events
 *
 * @author  Nick Kelly
 *
 *  MIT License
 *  http://www.opensource.org/licenses/mit-license
 */
ko.extenders.imageGrid=function(e,t){e.calculating=ko.observable(false);e.containerWidth=ko.observable(0);e.activeImage=ko.observable(-1);e.activateImage=function(t){e.activeImage(e.activeImage()===t?-1:t)};e.activeImage.subscribe(function(t){e.makeGrid()});e.calculateCutOff=function(t,n,r){var i=[],s=0;for(var o in r){i[o]=Math.floor(e()[r[o]].width()/t*n);s+=i[o]}var u=n-s;while(u>0){for(o in i){i[o]++;u--;if(u==0)break}}return i};e.makeGrid=function(){if(!e.calculating()){e.calculating(true);e.containerWidth(t.container.innerWidth());var n=e().length,r=0;while(n>0){var i=[],s=0,o=false;while(n>0&&s<e.containerWidth()){if(e.activeImage()===r){o=true}e()[r].rowEnd(false);i.push(r);s+=e()[r].width()+t.margins;r++;n--}if(o){e()[r-1].rowEnd(true)}o=false;var u=s-e.containerWidth(),a=i.length>0&&u>0?true:false,f=a?e.calculateCutOff(s,u,i):0;for(var l in i){var c=a?f[l]:0;if(typeof e()[i[l]].margin!=="undefined"){e()[i[l]].margin(a?Math.floor(c/2)*-1:0);e()[i[l]].vwidth(a?e()[i[l]].width()-c:e()[i[l]].width())}}}e.calculating(false)}};e.timer=null;e.subscribe(function(t){clearTimeout(e.timer);var n=t.length>0?t[t.length-1]:false;if(n&&typeof n.vwidth==="undefined"){n.vwidth=ko.observable(0);n.margin=ko.observable(0)}e.timer=setTimeout(function(){e.makeGrid()},5)});$(window).resize(function(){clearTimeout(e.timer);e.timer=setTimeout(function(){e.makeGrid()},50)});if(typeof t.imagePath!=="undefined"){e.limit=t.limit?t.limit:50;e.offset=t.offset?t.offset:0;e.infinityReached=false;e.getImages=function(){e.calculating(true);$.ajax({url:t.imagePath,method:t.ajaxMethod?t.ajaxMethod:"GET",data:{limit:e.limit,offset:e.offset},dataType:"json",success:function(t){if(t.length>0){$.each(t,function(t,n){e.push(ko.mapping.fromJS(n))});e.calculating(false)}if(t.length==0||t.length<e.limit){e.infinityReached=true}},error:function(){}})};if(t.infiniteScroll){$(window).scroll(function(t){if($(window).scrollTop()>=$(document).height()-$(window).height()-250){if(!e.infinityReached&&!e.calculating()){e.calculating(true);e.offset+=1;e.getImages()}}})}e.getImages()}return e};