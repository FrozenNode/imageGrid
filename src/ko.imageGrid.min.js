/**
 * A responsive image grid for Knockout.js
 * This is largely based off of the work done here: http://www.techbits.de/2011/10/25/building-a-google-plus-inspired-image-gallery/
 * modified for use with Knockout.js
 * uses jQuery for window Resize events
 *
 * @author  Nick Kelly
 *
 *  MIT License
 *  http://www.opensource.org/licenses/mit-license
 */
ko.extenders.imageGrid=function(e,t){e.calculating=ko.observable(false);e.calculateCutOff=function(t,n,r){var i=[],s=0;for(var o in r){i[o]=Math.floor(e()[r[o]].width()/t*n);s+=i[o]}var u=n-s;while(u>0){for(o in i){i[o]++;u--;if(u==0)break}}return i};e.makeGrid=function(){if(!e.calculating()){e.calculating(true);var n=t.container.innerWidth(),r=e().length,i=0;while(r>0){var s=[],o=0;while(r>0&&o<n){s.push(i);o+=e()[i].width()+t.margins;i++;r--}var u=o-n,a=s.length>0&&u>0?true:false,f=a?e.calculateCutOff(o,u,s):0;for(var l in s){var c=a?f[l]:0;if(typeof e()[s[l]].margin!=="undefined"){e()[s[l]].margin(a?Math.floor(c/2)*-1:0);e()[s[l]].vwidth(a?e()[s[l]].width()-c:e()[s[l]].width())}}}e.calculating(false)}};e.timer=null;e.subscribe(function(t){clearTimeout(e.timer);$.each(t,function(e,t){if(typeof t.vwidth==="undefined"){t.vwidth=ko.observable(0);t.margin=ko.observable(0)}});e.timer=setTimeout(function(){e.makeGrid()},5)});$(window).resize(function(){clearTimeout(e.timer);e.timer=setTimeout(function(){e.makeGrid()},50)});if(typeof t.imagePath!=="undefined"){e.limit=t.limit?t.limit:50;e.offset=t.offset?t.offset:0;e.infinityReached=false;e.getImages=function(){e.calculating(true);$.ajax({url:t.imagePath,method:t.ajaxMethod?t.ajaxMethod:"GET",data:{limit:e.limit,offset:e.offset},dataType:"json",success:function(t){if(t.length>0){$.each(t,function(t,n){e.push(ko.mapping.fromJS(n))});e.calculating(false)}if(t.length==0||t.length<e.limit){e.infinityReached=true}},error:function(){}})};if(t.infiniteScroll){$(window).scroll(function(t){if($(window).scrollTop()>=$(document).height()-$(window).height()-250){if(!e.infinityReached&&!e.calculating()){e.calculating(true);e.offset+=1;e.getImages()}}})}e.getImages()}return e};